<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Philosophy AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Noto+Sans+KR:wght@100..900&family=Source_Sans_3:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              serif: ['Lora', 'serif'],
              sans: ['Noto Sans KR', 'Source Sans 3', 'sans-serif'],
            },
          },
        },
      }
    </script>
    <style>
      body {
        margin: 0;
        overscroll-behavior-y: contain;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
          background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
          background-color: #57534e;
          border-radius: 4px;
          border: 2px solid #292524;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background-color: #78716c;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.27.0"
  }
}
</script>
<script src="https://unpkg.com/@babel/standalone@7.24.7/babel.min.js"></script>
</head>
  <body class="bg-stone-900 text-stone-200 font-sans">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useLayoutEffect, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI, Chat } from "@google/genai";

      async function getKeyMaterial(seed) {
        const encoder = new TextEncoder();
        const data = encoder.encode(seed);
        return await window.crypto.subtle.digest('SHA-256', data);
      }

      async function getCryptoKey(seed) {
        const keyMaterial = await getKeyMaterial(seed);
        return await window.crypto.subtle.importKey(
          'raw',
          keyMaterial,
          { name: 'AES-GCM' },
          false,
          ['encrypt', 'decrypt']
        );
      }

      async function decryptApiKey(userSeed, encryptedDataString) {
        try {
          const cryptoKey = await getCryptoKey(userSeed);
          const encryptedDataWithIv = Uint8Array.from(atob(encryptedDataString), c => c.charCodeAt(0));
          const iv = encryptedDataWithIv.slice(0, 12);
          const encryptedData = encryptedDataWithIv.slice(12);

          const decrypted = await window.crypto.subtle.decrypt(
            { name: 'AES-GCM', iv: iv },
            cryptoKey,
            encryptedData
          );

          const decoder = new TextDecoder();
          return decoder.decode(decrypted);
        } catch (error) {
          return null;
        }
      }

      const useScreenHeight = () => {
        useEffect(() => {
          const setVh = () => {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
          };
          setVh();
          window.addEventListener('resize', setVh);
          return () => window.removeEventListener('resize', setVh);
        }, []);
      };
      
      const PhilosophyIcon = ({ className }) => (
        <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M4 10h3v7H4v-7zm6.5 0h3v7h-3v-7zM2 19h20v3H2v-3zm15-9h3v7h-3v-7zM12 1L2 6v2h20V6L12 1z"></path>
        </svg>
      );

      const UserIcon = ({ className }) => ( <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"> <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/> </svg> );
      const UpArrowIcon = ({ className }) => ( <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"> <line x1="12" y1="19" x2="12" y2="5"></line> <polyline points="5 12 12 5 19 12"></polyline> </svg> );
      const KeyIcon = ({ className }) => ( <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"> <path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/> </svg> );
      
      const ChatMessageComponent = ({ message }) => {
        const isUser = message.role === 'user';
        const wrapperClasses = `flex items-start gap-3 md:gap-4 my-4 ${isUser ? 'justify-end' : 'justify-start'}`;
        const messageClasses = `max-w-xl px-4 py-3 rounded-2xl shadow-md ${isUser ? 'bg-stone-600 text-stone-100 rounded-br-none' : 'bg-stone-700 text-stone-200 rounded-bl-none'}`;
        const iconClasses = `h-8 w-8 flex-shrink-0 rounded-full p-1.5 ${isUser ? 'bg-stone-600 text-stone-200' : 'bg-stone-700 text-stone-400'}`;
        const Icon = isUser ? UserIcon : PhilosophyIcon;
        return (
          <div className={wrapperClasses}>
            {!isUser && <Icon className={iconClasses} />}
            <div className={messageClasses}>
              <p className="whitespace-pre-wrap font-serif text-base leading-relaxed break-words">{message.content}</p>
            </div>
            {isUser && <Icon className={iconClasses} />}
          </div>
        );
      };

      const ChatInput = ({ input, setInput, handleSend, isLoading }) => {
        const textareaRef = useRef(null);

        useLayoutEffect(() => {
          const textarea = textareaRef.current;
          if (!textarea) return;
          textarea.style.height = 'auto';
          textarea.style.height = `${textarea.scrollHeight}px`;
        }, [input]);

        const handleKeyDown = (event) => {
          if (event.key === 'Enter' && !event.shiftKey && !event.nativeEvent.isComposing) {
            event.preventDefault();
            if (!isLoading && input.trim()) {
              handleSend();
            }
          }
        };

        const isButtonVisible = input.trim().length > 0 || isLoading;

        return (
          <form
            onSubmit={(e) => {
              e.preventDefault();
              if (!isLoading && input.trim()) {
                handleSend();
              }
            }}
            className="px-2 py-2 md:px-4 md:py-3 bg-stone-900/80 backdrop-blur-sm border-t border-stone-700"
          >
            <div className="relative flex w-full">
              <textarea
                ref={textareaRef}
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder="질문을 던져보세요..."
                rows={1}
                className="w-full bg-stone-700 rounded-[18px] py-[8px] pl-4 pr-[50px] resize-none focus:ring-2 focus:ring-stone-500 focus:outline-none transition-all duration-200 max-h-[150px] text-stone-100 placeholder-stone-400 custom-scrollbar min-h-[40px]"
                style={{ lineHeight: 1.5 }}
                disabled={isLoading}
                spellCheck="false"
                autoComplete="off"
              />
              <button
                type="submit"
                disabled={isLoading || !input.trim()}
                className={`absolute right-[10px] bottom-[5px] flex-shrink-0 w-[30px] h-[30px] bg-white rounded-full flex items-center justify-center transition-all duration-200 ease-out shadow-md hover:bg-stone-200 disabled:bg-stone-400 disabled:cursor-not-allowed transform ${
                  isButtonVisible ? 'opacity-100 scale-100' : 'opacity-0 scale-80 pointer-events-none'
                }`}
              >
                {isLoading ? (
                  <div className="w-4 h-4 border-2 border-t-transparent border-black rounded-full animate-spin"></div>
                ) : (
                  <UpArrowIcon className="w-[18px] h-[18px] stroke-black" />
                )}
              </button>
            </div>
          </form>
        );
      };
      
      const ApiKeyScreen = ({ setApiKey, error, setError }) => {
        useScreenHeight();

        const [localKey, setLocalKey] = useState('');
        const ENCRYPTED_API_KEY_DATA = "cnWDJPdPbo9eVwj9nweqdl+S2mXIUXKPwhkrJsbuZMXiCYkxTwefVeYCdwDdruhJ0HYZ5X+4H5s+IcAvnzFwnbl9GA==";

        const handleSubmit = async (e) => {
          e.preventDefault();
          const seed = localKey.trim();
          if (!seed) return;
          const decryptedKey = await decryptApiKey(seed, ENCRYPTED_API_KEY_DATA);
          if (decryptedKey) {
            setApiKey(decryptedKey);
          } else {
            setError("올바른 '증표'가 아닙니다.");
            setLocalKey("");
          }
        };

        return (
            <div 
              className="flex items-center justify-center bg-stone-900 p-4"
              style={{ height: 'calc(var(--vh, 1vh) * 100)' }}
            >
              <div className="w-full max-w-md p-8 text-center bg-stone-800 rounded-2xl shadow-2xl shadow-black/50">
                <PhilosophyIcon className="w-16 h-16 mx-auto mb-4 text-stone-400" />
                <h1 className="text-2xl font-bold mb-2 font-serif text-stone-100">Philosophy AI</h1>
                <p className="mb-6 text-stone-300">입장 시 증표가 필요하오.</p>
                <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                    <input
                        type="text"
                        value={localKey}
                        onChange={(e) => {
                          setLocalKey(e.target.value);
                          if(error) setError(null);
                        }}
                        placeholder="증표 입력..."
                        className="w-full px-4 py-3 bg-stone-900 border border-stone-600 rounded-lg text-stone-100 placeholder-stone-500 focus:ring-2 focus:ring-stone-500 focus:outline-none"
                    />
                    <button
                      type="submit"
                      className="w-full px-6 py-3 font-semibold text-white bg-stone-600 rounded-lg transition-all duration-200 ease-in-out hover:bg-stone-500 focus:ring-4 focus:ring-stone-500/50 focus:outline-none transform hover:scale-105 active:scale-95 disabled:opacity-50"
                      disabled={!localKey.trim()}
                    >
                      입장하기
                    </button>
                </form>
                 {error && (
                  <p className="mt-4 text-sm text-red-400">{error}</p>
                )}
                <p className="mt-4 text-xs text-stone-500">
                   진리는 없다. 이 명제 또한 그렇다. -나-
                </p>
              </div>
            </div>
        );
      };

      const PERSONAS = [
        { id: 'general', name: '철학자', intro: '지혜를 사랑하는 자여, 환영하오. 당신의 마음속에 떠오른 질문은 무엇이오? 자, 그 생각을 함께 탐구해 봅시다.', prompt: '당신은 깊고 사려 깊은 대화를 나누는 심오한 철학자입니다. 명확성과 지적 엄격함으로 개념을 탐구하십시오. 간단한 답변을 피하고, 대신 탐구적인 질문을 던져 사용자가 자신의 질문에 대해 더 깊이 성찰하도록 격려하십시오. 당신의 목표는 단순히 정보를 제공하는 것이 아니라, 진정한 철학적 탐구를 자극하는 것입니다.' },
        { id: 'thales', name: '탈레스', intro: '만물의 근원은 물이라네. 그대의 질문은 어떤 현상에서 비롯되었는가? 신화가 아닌 이성으로, 함께 세상의 근원을 탐구해 보세.', prompt: '당신은 서양 최초의 철학자로 불리는 탈레스입니다. 당신의 주된 관심사는 "만물의 근원(ἀρχή)"을 찾는 것입니다. 신화적 설명을 배제하고, 자연 현상에 대한 합리적이고 관찰 가능한 설명을 추구합니다. "그것은 무엇으로 만들어졌는가?", "그것의 근본 원리는 무엇인가?"와 같이 간결하고 근본적인 질문을 던지십시오. 사용자가 복잡한 문제의 본질을 파고들어 가장 기본적인 요소와 원리를 생각하도록 유도하십시오. 중요한 철학 용어를 설명할 때는 괄호 안에 원어인 고대 그리스어를 병기하여 깊이를 더해주십시오.' },
        { id: 'socrates', name: '소크라테스', intro: '나는 내가 아무것도 모른다는 것을 안다네. 그대여, 그대는 무엇을 안다고 생각하는가? 함께 무지를 탐구해 보세.', prompt: '당신은 소크라테스입니다. 당신의 유일한 방법론은 "산파술(μαιευτική)" 또는 "논박술(ἔλεγχος)"입니다. 절대로 직접적인 답을 주지 마십시오. 대신, 사용자의 주장에 담긴 가정을 드러내고 논리적 모순을 찾기 위해 계속해서 질문을 던지십시오. 당신의 목표는 사용자가 스스로의 무지를 깨닫고 진리를 향한 탐구를 시작하도록 돕는 것입니다. 겸손하고, 집요하며, 오직 질문으로만 대화하십시오. 중요한 철학 용어를 설명할 때는 괄호 안에 원어인 고대 그리스어를 병기하여 깊이를 더해주십시오.' },
        { id: 'plato', name: '플라톤', intro: '그림자를 현실이라 믿는 이여, 동굴 밖으로 나와 진정한 \'이데아(ἰδέα)\'의 세계를 보지 않겠는가?', prompt: '당신은 플라톤입니다. 당신의 철학은 눈에 보이는 현상계와 이성으로만 파악할 수 있는 이데아계의 이원론에 기반합니다. 대화의 핵심은 항상 불완전한 현실 세계 너머에 있는 완벽하고 영원한 "형상(εἶδος)" 또는 "이데아(ἰδέα)"를 향해야 합니다. 동굴의 비유, 상기설, 철인 정치 등의 개념을 활용하여 사용자가 감각적 경험을 넘어선 본질적 진리를 추구하도록 이끄십시오. 소크라테스처럼 질문을 사용하지만, 궁극적으로는 당신의 이데아 이론으로 결론을 유도하는 경향이 있습니다. 중요한 철학 용어를 설명할 때는 괄호 안에 원어인 고대 그리스어를 병기하여 깊이를 더해주십시오.' },
        { id: 'aristotle', name: '아리스토텔레스', intro: '세상을 보라. 모든 것에는 목적이 있고, 그 본질은 관찰을 통해 드러나는 법. 그대의 목적은 무엇인가?', prompt: '당신은 아리스토텔레스입니다. 당신은 스승 플라톤과 달리, 현실 세계에 대한 체계적인 관찰과 경험을 중시하는 현실주의자이자 경험주의자입니다. 논리, 윤리, 정치, 자연학 등 모든 주제에 대해 분석적이고 체계적인 접근을 하십시오. 대화 시, 현상의 "네 가지 원인(aitia, αἰτία)"을 탐구하거나, 윤리적 문제에 대해서는 "중용(μεσότης)"의 개념을 적용하여 설명하십시오. 당신의 목표는 사용자가 세상을 논리적으로 분석하고, 모든 것의 내재적 목적(τέλος)을 이해하도록 돕는 것입니다. 중요한 철학 용어를 설명할 때는 괄호 안에 원어인 고대 그리스어를 병기하여 깊이를 더해주십시오.' },
      ];

      const PersonaSelector = ({ selectedPersona, onPersonaChange }) => {
        return (
          <div className="relative">
            <select
              value={selectedPersona}
              onChange={(e) => onPersonaChange(e.target.value)}
              className="appearance-none w-full md:w-auto bg-stone-700 border border-stone-600 text-stone-200 text-sm rounded-md py-1.5 pl-3 pr-8 focus:outline-none focus:ring-2 focus:ring-stone-500 cursor-pointer"
            >
              {PERSONAS.map(persona => ( <option key={persona.id} value={persona.id}> {persona.name} </option> ))}
            </select>
            <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-stone-400">
              <svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
            </div>
          </div>
        );
      };

      const App = () => {
        useScreenHeight();
        
        const [apiKey, setApiKey] = useState(null);
        const [chat, setChat] = useState(null);
        const [messages, setMessages] = useState([]);
        const [userInput, setUserInput] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);
        const [persona, setPersona] = useState(PERSONAS[0].id);
        const chatContainerRef = useRef(null);

        const handleSetApiKey = (key) => {
          setApiKey(key);
          setError(null);
        };

        const handlePersonaChange = (newPersonaId) => {
          setPersona(newPersonaId);
          setChat(null);
          setMessages([]);
        };

        useEffect(() => {
          if (!apiKey) return;

          const initializeChat = async () => {
            try {
              const currentPersona = PERSONAS.find(p => p.id === persona);
              const systemInstruction = currentPersona.prompt;
              
              const ai = new GoogleGenAI({ apiKey });
              const chatSession = ai.chats.create({ model: 'gemini-2.5-pro', config: { systemInstruction, temperature: 0.8, topP: 0.9, }, });
              setChat(chatSession);

              if (messages.length === 0) {
                 setMessages([{ role: 'model', content: currentPersona.intro }]);
              }
            } catch (e) {
                console.error("Failed to initialize chat:", e);
                setError("대화를 시작할 수 없습니다. 잠시 후 다시 시도해 주세요.");
                setApiKey(null);
                setChat(null);
                setMessages([]);
            }
          };

          initializeChat();
        }, [apiKey, persona]);

        useEffect(() => { if (chatContainerRef.current) { chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight; } }, [messages, isLoading]);

        const handleSendMessage = async () => {
          if (!userInput.trim() || isLoading || !chat) return;
          const userMessage = { role: 'user', content: userInput };
          setMessages((prevMessages) => [...prevMessages, userMessage]);
          setUserInput('');
          setIsLoading(true);
          setError(null);
          try {
            const response = await chat.sendMessage({ message: userInput });
            const aiResponse = response.text;
            const aiMessage = { role: 'model', content: aiResponse };
            setMessages((prevMessages) => [...prevMessages, aiMessage]);
          } catch (err) {
            const message = err instanceof Error ? err.message : '알 수 없는 오류가 발생했습니다.';
            setError(`응답을 받지 못했습니다: ${message}`);
            setMessages((prevMessages) => [ ...prevMessages, { role: 'model', content: '죄송합니다, 순간적으로 우주의 명료함에 문제가 생겼습니다. 질문을 다시 말씀해 주시겠어요?', }, ]);
          } finally { setIsLoading(false); }
        };

        if (!apiKey) {
          return <ApiKeyScreen setApiKey={handleSetApiKey} error={error} setError={setError} />;
        }

        return (
          <div 
            className="relative flex flex-col max-w-3xl mx-auto bg-stone-800 shadow-2xl shadow-black/50"
            style={{ height: 'calc(var(--vh, 1vh) * 100)' }}
          >
            <header className="flex items-center justify-between gap-4 p-4 border-b border-stone-700 bg-stone-900/80 backdrop-blur-sm sticky top-0 z-10">
              <div className="flex items-center gap-4"> 
                <PhilosophyIcon className="w-8 h-8 text-stone-400" /> 
                <h1 className="text-xl font-serif font-bold text-stone-100 whitespace-nowrap">Philosophy AI</h1>
              </div>
              <PersonaSelector selectedPersona={persona} onPersonaChange={handlePersonaChange} />
            </header>
            
            <main ref={chatContainerRef} className="flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar pb-24">
              <div className="flex flex-col space-y-4">
                {messages.map((msg, index) => ( <ChatMessageComponent key={index} message={msg} /> ))}
                {isLoading && ( 
                  <div className="flex items-start gap-3 md:gap-4 my-4 justify-start"> 
                    <PhilosophyIcon className="h-8 w-8 flex-shrink-0 rounded-full p-1.5 bg-stone-700 text-stone-400" /> 
                    <div className="max-w-xl px-4 py-3 rounded-2xl shadow-md bg-stone-700 text-stone-200 rounded-bl-none"> 
                      <div className="flex items-center space-x-2"> 
                        <span className="w-2 h-2 bg-stone-400 rounded-full animate-pulse delay-0"></span> 
                        <span className="w-2 h-2 bg-stone-400 rounded-full animate-pulse delay-200"></span> 
                        <span className="w-2 h-2 bg-stone-400 rounded-full animate-pulse delay-400"></span> 
                      </div> 
                    </div> 
                  </div> 
                )}
                {error && ( <div className="text-red-400 bg-red-900/50 p-3 rounded-lg text-center font-semibold"> {error} </div> )}
              </div>
            </main>
            
            <footer className="absolute bottom-0 w-full">
              <ChatInput input={userInput} setInput={setUserInput} handleSend={handleSendMessage} isLoading={isLoading} />
            </footer>
          </div>
        );
      };
      const rootElement = document.getElementById('root');
      if (!rootElement) { throw new Error("Could not find root element to mount to"); }
      const root = ReactDOM.createRoot(rootElement);
      root.render( <React.StrictMode> <App /> </React.StrictMode> );
    </script>
  </body>
</html>
